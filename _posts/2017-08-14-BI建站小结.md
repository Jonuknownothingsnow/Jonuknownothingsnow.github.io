---
title: BI建站小结
catalog: 
- 全栈溢出（笑）
date: 2017-08-14
---

# 项目review

前段时间因为公司有数据方面的需要，但是目前的公司的BI系统又比较基础，可定制化的程度也不高，而且目前公司好像各个方面的资源也比较紧张。正好碰到有个项目需要可交互地展示数据，我就自己花一个周末的时间建了个数据展示的Demo站点，来总结一下。

<!-- more -->

## 技术选型

第一个面对的问题是技术选型，磨刀不误砍柴功，一定要在技术选型花点时间，万一为了酷炫选了一种不是很熟悉的技术，可能踩到一个坑两天就过去了。慎重慎重。

### 后端：flask+gunicorn+nginx

后端框架上一开始我是打算这次用Django搭站点的，但是一来最近django很久没用了，二来这次本来就是开发一个demo级别的，本来就是我们数据处理的效果而已，实在没必要上这么重的框架，还是flask。

为什么选择gunicorn而不是熟悉的uwsgi呢？原因是因为我那台日本服务器之前被我折腾了一下，uwsgi装不上去，这个时候也只能先不求甚解地换成gunicorn了。

nginx没啥好选的。



### 数据处理/可视化：Pandas+bokeh+Sklearn

数据处理这一块没有太大的可选择性，基础的切片聚合运算等处理肯定是选择pandas的，机器学习sklearn也相当成熟，我们这种小数据量的演示也不需要上tensorflow。唯一需要选择的内容其实是可视化方面。

matplotlib+seaborn是更为常见的可视化选择，而且pandas对matplotlib还有一些特殊的快捷方式。但是这里我最后还是选择了bokeh，其实做这个选择不但要在数据可视化的角度考虑，还需要在前端的角度考虑。毕竟我们这个站点是使用页面来展示可视化结果的，我内心里还是希望它能有一些交互性。bokeh在这个方面相对更有优势一些。



### 前端：bootstrap+bokeh.js

基本框架选择了简单明了的bootstrap，同时有在考虑的还有Semantic-UI,选择bootstrap只是因为之前用过，避免踩坑。

在前端的数据展示上其实之前有考虑过很多方案，比如matplotlib+seaborn生成的图片，后端只处理数据前端使用d3.js进行绘图等，不过考虑到展示效果以及需要额外学习的技术内容，最终还是选择了bokeh.js，这样我就可以安心在python上制作视图与交互，暂时不需要考虑js方面的问题。

额外提一下，现在网络上关于bokeh.js的使用大部分都是很陈旧或是有错误的，我当时研究了半天才研究出来从如何从用flask把bokeh的figure对象传到jinja模板当中进行显示，之后会另写一篇讲下具体方法，这里就不赘述了。

bokeh最终的展示效果还是不错的，自带放大、选中、hover等看图的小工具，并且可以针对工具栏与按钮进行定制，能够满足基本的交互需求。

### 数据库：csv/mysql

看到这里大家可能会大失所望，怎么能用csv这么low的数据持久化方式呢？大家别急着喷我，这次这个站点使用的数据本来就是静态的，建在我私人的服务器上（本来用来搭shadowsock的日本服务器），根本就连不了公司的数据库。反正数据量也不大，暂时用csv保存，运行的时候反正是读取在内存里进行操作的，也不会在性能上拖后腿，与其说是csv做数据库，其实可以说是内存里的dataframe在做数据库的工作。

之后迁移到公司的服务器的话肯定是用公司的mysql，这个没什么好说的。

~~我也想上hadoop+spark啊同志~~



## 建站历程

虽然最后算是顺利地把站点建出来了，其实磕磕碰碰也不少，

因为之前在阿里云上搭过好几次网站，所以环境上其实没有碰到什么的大的问题，最大的麻烦其实也就是uwgsi装不上去。不过现在建站还是有点不科学的徒手建，其实已经落后时代很多了，之后还是要用virtualenv或者pipenv虚拟环境才比较跟得上时代潮流。

flask+gunicorn+nginx的部署还是挺成熟的，不过要注意的是nginx有个cache，比方说一个模板修改完之后没改名字，nginx还是会默认显示旧的页面，因为它以为是同一个。在网上看了下好像也没有比较优雅的强制刷新cache的方法，所以还是改一次就换一次版本名吧\_(:з」∠)_

数据处理和一些算法单独写了一个模块给BI的蓝图调用，基本上蓝图里只用调下方法，把结果传给bokeh进行绘制就可以了。如果以后需要把这些算法做成API，再注册个api的蓝图也是很快的。感觉这个位置还是需要解耦合。

前端的模板之前经常有用bootstrap写点页面，所以写起来也还算顺手。

主要花时间的几个方面：

* bokeh.js和bokeh的具体联动。这个试了很久才成功，一度想放弃。


* 编写相关算法。毕竟是要拿出来唬人的，没点自己的东西还是不行。
* 数据展现形式的调整。本来做出来一般，后来和产品讨论一下发现又有新的展现形式可能更好，吭哧吭哧又去改。



# 改进方向

现在只是一个demo，之后要做的事情有:

* 搬回公司服务器
* 更改展现形式，现在是堆在一个demo页面里，预期未来是数据门户+dashboard的形式，不同的功能分布在不同的页面
* 用户登录验证，查看权限
* 整合其他已有的数据工具和之前自己写的其他模块
* 前端的框架可能需要大的改变，预期最终稳定为vue+d3.js做前端展示

![好吃.jpg](https://i.loli.net/2017/08/14/5991904fb9f37.jpg)



























